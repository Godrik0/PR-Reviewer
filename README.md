# PR Reviewer Assignment Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–≤—å—é–µ—Ä–æ–≤ –Ω–∞ Pull Request'—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥–∞–º–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.

–°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –¥–æ 2 —Ä–µ–≤—å—é–µ—Ä–æ–≤ –Ω–∞ PR –∏–∑ –∫–æ–º–∞–Ω–¥—ã –∞–≤—Ç–æ—Ä–∞, –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–µ–≤—å—é–µ—Ä–æ–≤ –∏ –ø–æ–ª—É—á–∞—Ç—å —Å–ø–∏—Å–æ–∫ PR'–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ 2 –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–≤—å—é–µ—Ä–æ–≤ –∏–∑ –∫–æ–º–∞–Ω–¥—ã –∞–≤—Ç–æ—Ä–∞
- –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–µ–≤—å—é–µ—Ä–æ–≤ –∏–∑ –∫–æ–º–∞–Ω–¥—ã –∑–∞–º–µ–Ω—è–µ–º–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ—Å–ª–µ merge PR
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–∞–º–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –ú–∞—Å—Å–æ–≤–∞—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º PR
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
- –ú–µ—Ç—Ä–∏–∫–∏ Prometheus –∏ –¥–∞—à–±–æ—Ä–¥—ã Grafana
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å k6

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **–Ø–∑—ã–∫**: Go 1.21+
- **HTTP Router**: `github.com/go-chi/chi/v5`
- **ORM**: `gorm.io/gorm` + `gorm.io/driver/postgres`
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: PostgreSQL 15
- **Logging**: `log/slog`
- **Metrics**: Prometheus + Grafana
- **Config**: `viper`
- **Testing**: `testify`, `httptest`
- **Load Testing**: k6
- **Linter**: `golangci-lint`

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker –∏ Docker Compose
- Go 1.21+

### –ó–∞–ø—É—Å–∫ —Å –ø–æ–º–æ—â—å—é Docker Compose

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose up -d

# –ò–ª–∏ —Å –ø–æ–º–æ—â—å—é Makefile
make docker-up
```

–°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞:
- **API**: http://localhost:8080
- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3000 (admin/admin)

## üìö API Endpoints

–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ [openapi.yaml](openapi.yaml).

### –ö–æ–º–∞–Ω–¥—ã

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ | Auth |
|-------|------|----------|------|
| POST | `/team/add` | –°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É | Public |
| GET | `/team/get` | –ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–∞–Ω–¥—É | User/Admin |
| POST | `/team/deactivateUsers` | –ú–∞—Å—Å–æ–≤–∞—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | Admin |

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ | Auth |
|-------|------|----------|------|
| POST | `/users/setIsActive` | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ | Admin |
| GET | `/users/getReview` | –ü–æ–ª—É—á–∏—Ç—å PR'—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | User/Admin |

### Pull Requests

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ | Auth |
|-------|------|----------|------|
| POST | `/pullRequest/create` | –°–æ–∑–¥–∞—Ç—å PR | Admin |
| POST | `/pullRequest/merge` | Merge PR (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ) | Admin |
| POST | `/pullRequest/reassign` | –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–µ–≤—å—é–≤–µ—Ä–∞ | Admin |

### –°–ª—É–∂–µ–±–Ω—ã–µ

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| GET | `/health` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞ |
| GET | `/metrics` | –ú–µ—Ç—Ä–∏–∫–∏ Prometheus |
| GET | `/stats` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π |

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# Server
PR_REVIEWER_SERVER_PORT=8080
PR_REVIEWER_SERVER_READ_TIMEOUT=10
PR_REVIEWER_SERVER_WRITE_TIMEOUT=10

# Storage
PR_REVIEWER_STORAGE_TYPE=postgres  # –∏–ª–∏ memory
PR_REVIEWER_STORAGE_POSTGRES_URL=<connection-string>

# Auth
PR_REVIEWER_AUTH_TYPE=static
PR_REVIEWER_AUTH_ADMIN_TOKEN=admin-secret-token
PR_REVIEWER_AUTH_USER_TOKEN=user-secret-token

# Logging
PR_REVIEWER_LOG_LEVEL=info  # debug, info, warn, error
```

### –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–¢–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `config.yaml`:

```yaml
server:
  port: 8080
  read_timeout: 10
  write_timeout: 10

storage:
  type: postgres
  postgres_url: "host=localhost port=5432 user=prreviewer password=prreviewer123 dbname=prreviewer sslmode=disable"

auth:
  type: static
  admin_token: admin-secret-token
  user_token: user-secret-token

log_level: info
```
## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit –∏ Integration —Ç–µ—Å—Ç—ã

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
make test

# –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã
make test-short
```

### –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `make test` –æ—Ç–∫—Ä–æ–π—Ç–µ `coverage.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ.

–¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ: **~50%**

## –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# –° –ø–æ–º–æ—â—å—é Makefile
make load-test

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é
docker-compose run --rm k6 run /scripts/main-load-test.js --out experimental-prometheus-rw
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∞** (`load-testing/scripts/main-load-test.js`):

- **–ü—Ä–æ–≥—Ä–µ–≤**: 30s –¥–æ 10 VU
- **–õ–µ–≥–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞**: 1m –¥–æ 100 VU
- **–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞**: 15m –Ω–∞ 400 VU
- **–û—Å—Ç—ã–≤–∞–Ω–∏–µ**: 1m –¥–æ 0 VU

**–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (SLI)**:
- `p(95) < 200ms` - 95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
- `rate < 0.01` - –î–æ–ª—è –æ—à–∏–±–æ–∫ < 1%

### **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**

**–¢–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ**:
- CPU: AMD Ryzen 7 6800H
- RAM: 16 GB
- PostgreSQL: 15-alpine

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**:

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –°—Ä–µ–¥–Ω–∏–π RPS | ~800 req/s |
| p(90) latency | 18.76ms |
| p(95) latency | 22.78ms |
| –£—Å–ø–µ—à–Ω–æ—Å—Ç—å | 99.99% |
| Max VU | 400 |

### –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Ç—Ä–∏–∫

–ú–µ—Ç—Ä–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Grafana:
1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∞—à–±–æ—Ä–¥ "k6 Prometheus"
3. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Prometheus

–ú–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ http://localhost:9090:

- `pr_reviewer_http_requests_total` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- `pr_reviewer_http_request_duration_seconds` - –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- `process_resident_memory_bytes` - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- `process_cpu_seconds_total` - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU
- `go_goroutines` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Ä—É—Ç–∏–Ω

### Grafana

–î–∞—à–±–æ—Ä–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ http://localhost:3000 (admin/admin):

1. **Go Application Dashboard** - –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - HTTP Request Rate
   - 95th Percentile Request Duration
   - Memory Usage
   - CPU Usage
   - Goroutines

2. **k6 Dashboard** - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - HTTP requests
   - Response times
   - Error rate
   - Virtual Users
